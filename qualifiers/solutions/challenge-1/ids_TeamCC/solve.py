#!/usr/bin/env python3

from pwn import *
import time
import sys
import json
import binascii
import hashlib

loc = len(sys.argv)
if loc == 2:
    HOST = '192.168.16.2'
else:
    HOST = os.environ.get('HOST', 'localhost')
PORT = 31337

r = remote(HOST, int(PORT))
r.recvuntil(b'> ')
j0 = b'4{"hash": 90332780745442119779253857231558597566447620910226630319466684469499960556217, "ctxt": 73051477874175319898927301574056890898704116542880899811855416465272643682482346872783064596681132500093342543927350264317816705056726017562052386926181322166187767850184465510257796954957460330077783876352326207867696650111732540101368587373210436484887313543491225210356125240581684161338044619494047854900183079330422962318329546393970108675111208668731515310810119669669785116258853775579596914067264319604960692189737974799003960161097925809658756864172165995060221657693350799455527766362031052645281448993284426009064500366073322116732260765304288850209892843144957962916560778212599399552579286945076904181402045509524352633967429874194201741806721664196445347759142097532829953125517498551062761903031892701576548444435244611198108640987159546381903097946809287365052398012455687453466700260273341554786191027926777189035233725939692111334381040651927022112173802116643713729121047574308803077213575536485741502404927006914803136414467058642884171002528878169339845622793977402503234182588769709154961649934730828326538949645182926356414533497836632833727562183129066423778578583057064315858610392480954433559213008717680626378247498277787414520519791236257431556708009843017374097633810653489799748754465484619328171001827}'
j1 = b'5'
r.sendline(j1)
if loc == 2:
    r.recvline() # 
r.recvline() #     challenge
r.recvline() #     gen.py
r.recvline() #     key.json
r.recvline() #     nsjail.conf
r.recvline() #     run.sh
r.recvline() #     submitter
res = r.recvline() #     {"hash": 90332780745442119779253857231558597566447620910226630319466684469499960556217, "ctxt": 332670797123917431507972254420820776807268844617923807947020524833339964447865926722670577973259526698295349038600720535018550079218507612191483114322992755261668791007869802702008960400709659700136149485868275441537282378024368735791852651741966004746177839784928695111543486919143548434131965968004747213320888718641038719138077767881534636466215052104136078235489866178822291220274928638570188143650325803633931772436004575253773122884324468978295612951196345464958636929631891096856023773781107270185852964284774777348312254569459717365358628365098949763215966140233802364705637194788034632900756341261888230795730585302386305075489736468604170062272878540667814257683980625227180114783263855649729057546982277880557693952770544716371965756146565643116997866322432600168293940112163812799009698287351765187343677869726634264952580036282446041093441616454058286066499508058720162924082301472593417466111012414566956297280634510730875905234612810570370722237850183023050376856069865869565751386627969740378189626688301719741615181794811940424349103943062262607997908558289344048028069801114201169386830815787286126013973436921559918264277322113924729555982055472995738693754686939819772484092621120892091968528418435938988172367151, "n": 19882248289808164969404782568640670424466230561949693581316787003172053339763897684154090214684834374039393267255757027519671748398855561242170295391921017716508615387254641753630535612284679136965305881192051079438981030575054801002172784084666842549803857789321616276814834620199755282538100640537803928216770502059082581549202472160486403416214810080869770984312795295125902381046655579576858603625530856815248846861166429937788468741887065866501135197929041355072723927231359735249938651748593117104298803564548704142506531832828967255741499043018960028575389779690118145120184986740096214471098419620980042114129}
# print(res)
j0 = res[:-1]
j0 = json.loads(j0)
# print(j0['hash'])

hash0 = j0['hash']
ct0 = j0['ctxt']
n = j0['n']
pt0 = int(binascii.hexlify(b'ls'), 16)

pt1 = int(binascii.hexlify(b'./submitter'), 16)
x = pt1 * pow(pt0, -1, n*n) % (n*n)
ct1 = pow(ct0, x, n*n)
hash1 = int(hashlib.sha256(b'./submitter').hexdigest(), 16)
j1 = {
    'hash': hash1,
    'ctxt': ct1
}
j1 = json.dumps(j1).encode()
j1 = b'4' + j1
r.sendline(j1)


# r.recvline_contains(b'You sent: ')
# r.sendline(b'./submitter')

# flag = r.recvline().decode().strip()
# log.info('Flag: %s', flag)

time.sleep(.1)
flag = r.recvall().decode().strip()
log.info('Flag: %s', flag)
