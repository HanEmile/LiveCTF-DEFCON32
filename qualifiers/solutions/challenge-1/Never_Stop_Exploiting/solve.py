#!/usr/bin/env python3

from pwn import *
import json

#context.log_level = "debug"

HOST = os.environ.get('HOST', 'localhost')
PORT = 31337

io = remote(HOST, int(PORT))
#io = process("./challenge")


io.recvuntil(b"> ")
io.sendline(b"5 ")
io.recvuntil(b"submitter\n")
res = io.recvline()

print("res:", res)

data_dict = json.loads(res.decode().strip())

ctxt = data_dict['ctxt']
n = int(data_dict['n'])
n_sq =  n ** 2
ctxt_hash = data_dict['hash']
    
message = b"ls"
assert int(hashlib.sha256(message).hexdigest(), 16) == ctxt_hash, "hash not equal"
target = b"./submitter =3"

target_num = int.from_bytes(target, "big")
message_num = int.from_bytes(message, "big")

assert target_num % message_num == 0
# ctxt = enc(target_num)
ctx_hash = int(hashlib.sha256(target).hexdigest(), 16)

mul = target_num // message_num
tctxt = pow(ctxt, mul, n_sq)
assert 0< tctxt < n_sq
thx = format(tctxt, 'x')

payload = json.dumps({"ctxt": tctxt, "hash": ctx_hash})

io.recvuntil(b"> ")
io.sendline(b"4" + b" " + payload.encode())
res = io.recvline()
print(res)
# output = b""
# try:
#     output = io.recvall(timeout=3)
#     print("output:", output)
# except Exception as e:
#     print("error:", e)